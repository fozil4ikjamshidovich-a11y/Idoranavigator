<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>IDORANAV ‚Äî –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body { height: 100%; margin:0; padding:0; background:#121212; color:#fff; font-family:"Segoe UI",Arial,sans-serif; }
#map { width:100%; height:100%; }

#controls {
  position:fixed; top:10px; left:50%; transform:translateX(-50%);
  background:rgba(20,20,20,0.95); padding:10px; border-radius:12px;
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center; z-index:1000; width:95%; max-width:420px;
}
#controls button, #controls input { font-size:14px; border-radius:8px; border:none; }
#controls button{ padding:8px 10px; background:#1DB7DD; color:white; flex:1 1 45%; transition:0.2s; }
#controls button:active{ background:#1597b5; }

#transportButtons { display: flex; flex:1 1 100%; gap:5px; flex-wrap:wrap; margin-top:5px; }
#searchBox { display:flex; flex:1 1 100%; gap:5px; }
#searchInput { flex:1; padding:6px; border-radius:6px; border:none; outline:none; }

#transportCheckboxes{display:flex; gap:6px; flex-wrap:wrap; margin-top:5px;}
#results {
  position: fixed; top:70px; left:50%; transform:translateX(-50%);
  width:90%; max-width:400px;
  background:rgba(25,25,25,0.95); border-radius:10px; padding:5px; z-index:1001;
  display:none; max-height:50vh; overflow-y:auto;
}
.result-item { padding:8px; border-bottom:1px solid #333; cursor:pointer; }
.result-item:hover{ background: rgba(255,255,255,0.06); }

#routeOptions {
  position: fixed; bottom:80px; left:50%; transform:translateX(-50%);
  max-width:400px; width:90%;
  background: rgba(25,25,25,0.95); border-radius:10px; padding:10px;
  color:#fff; z-index:1001; display:none; max-height:200px; overflow-y:auto;
}
.route-item { padding:8px; margin-bottom:5px; border-radius:6px; background:rgba(30,30,30,0.9); cursor:pointer; }

.toast {
  position: fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:#1DB7DD; color:white; padding:10px 20px; border-radius:8px;
  font-size:14px; opacity:0; transition:0.3s; z-index:1000;
}
.toast.show{ opacity:1; }

#permissionModal {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.8); display:none;
  align-items:center; justify-content:center; z-index:2000;
}
#permissionModal div { background:#1e1e1e; padding:20px; border-radius:10px; max-width:320px; text-align:center; }
#permissionModal button { margin-top:10px; background:#1DB7DD; color:white; border:none; border-radius:8px; padding:8px 16px; }

.user-arrow { width:36px; height:36px; display:flex; align-items:center; justify-content:center; transform-origin:center; }
.user-arrow svg { filter: drop-shadow(0 0 6px rgba(0,215,255,0.6)); }
</style>
</head>
<body>

<div id="controls">
  <button id="btnLocate">üìç –ú–æ–µ –º–µ—Å—Ç–æ</button>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="–ù–∞–π—Ç–∏ –º–µ—Å—Ç–æ...">
    <button id="btnSearch">üîç</button>
  </div>

  <div id="transportButtons">
    <button id="btnCar">üöó –ê–≤—Ç–æ</button>
    <button id="btnBike">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</button>
    <button id="btnFoot">üö∂ –ü–µ—à–∫–æ–º</button>
  </div>

  <div id="transportCheckboxes">
    <label><input type="checkbox" value="bus" checked> –ê–≤—Ç–æ–±—É—Å</label>
    <label><input type="checkbox" value="minibus" checked> –ú–∞—Ä—à—Ä—É—Ç–∫–∞</label>
    <label><input type="checkbox" value="trolleybus" checked> –¢—Ä–æ–ª–ª–µ–π–±—É—Å</label>
    <label><input type="checkbox" value="subway" checked> –ú–µ—Ç—Ä–æ</label>
  </div>

  <button id="btnStart">‚ñ∂ –í –ø—É—Ç—å</button>
  <button id="btnClear">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div id="map"></div>
<div id="results"></div>
<div id="routeOptions"></div>
<div class="toast" id="toast"></div>

<div id="permissionModal">
  <div>
    <h3>–†–∞–∑—Ä–µ—à–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é</h3>
    <p>–ß—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</p>
    <button id="btnRetry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====== */
let map, userMarker, watchId, routeLine, destinationMarker;
let currentLocation = [41.3111, 69.2797];
let destination = null;
let profile = "car";
let transportCache = {};
let stopMarkers = [];
let transportRoutes = [];
let navSteps = [];
let navIndex = 0;
let lastSpokenKind = "";

/* ====== Toast ====== */
function showToast(msg, time=3000){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), time); }

/* ====== Map init ====== */
function initMap(){
  map=L.map("map").setView(currentLocation,13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19, attribution:"¬© OSM"}).addTo(map);
  const svg=`<div class="user-arrow"><svg width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g1" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#00e5ff"/><stop offset="1" stop-color="#0066ff"/></linearGradient></defs><path d="M12 2 L3 20 L12 15 L21 20 Z" fill="url(#g1)" stroke="#fff" stroke-opacity="0.06"/></svg></div>`;
  const icon=L.divIcon({html:svg,className:'',iconSize:[36,36],iconAnchor:[18,18]});
  userMarker=L.marker(currentLocation,{icon}).addTo(map);

  map.on("click", e=>{ const dest=[e.latlng.lat,e.latlng.lng]; setDestination(dest,"–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞"); });
}
initMap();

/* ====== Permissions ====== */
function requestLocationPermission(){ if(!navigator.permissions){ locateUser(); return; } navigator.permissions.query({name:'geolocation'}).then(res=>{ if(res.state==='granted'||res.state==='prompt') locateUser(); else document.getElementById("permissionModal").style.display="flex"; }); }
function locateUser(){ if(!navigator.geolocation){ showToast("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); initMap(); return; } navigator.geolocation.getCurrentPosition(pos=>{ currentLocation=[pos.coords.latitude,pos.coords.longitude]; if(userMarker) userMarker.setLatLng(currentLocation); map.setView(currentLocation,15); showToast("–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"); }, err=>{ console.warn(err); document.getElementById("permissionModal").style.display="flex"; if(!map) initMap(); }, { enableHighAccuracy:true, timeout:7000 }); }

/* ====== Search ====== */
async function searchPlace(){
  const q=document.getElementById("searchInput").value.trim();
  const box=document.getElementById("results");
  if(!q) return showToast("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Å—Ç–æ");
  box.innerHTML="<div class='result-item'>–ü–æ–∏—Å–∫...</div>"; box.style.display="block";
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=10`);
    const data=await res.json();
    if(!data.length){ box.innerHTML="<div class='result-item'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>"; return; }
    box.innerHTML=data.map((p,i)=>`<div class='result-item' data-i='${i}'><b>${p.display_name.split(",")[0]}</b><br><small>${p.display_name}</small></div>`).join('');
    document.querySelectorAll(".result-item").forEach(el=>{ el.onclick=()=>{ const p=data[el.dataset.i]; const dest=[parseFloat(p.lat),parseFloat(p.lon)]; box.style.display="none"; setDestination(dest,p.display_name); }; });
  }catch(e){ console.error(e); box.innerHTML="<div class='result-item'>–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>"; }
}

/* ====== Set destination ====== */
function setDestination(dest,name){
  if(destinationMarker) map.removeLayer(destinationMarker);
  destinationMarker=L.marker(dest,{title:name}).addTo(map);
  destination=dest;
  buildRoute(currentLocation,destination);
  fetchTransportLines(dest);
}

/* ====== Build route (OSRM) ====== */
function buildRoute(start,end){
  if(!end) return;
  const url=`https://router.project-osrm.org/route/v1/${profile}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson&steps=true`;
  fetch(url).then(r=>r.json()).then(data=>{
    if(!data.routes?.length){ showToast("–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); navSteps=[]; return; }
    const r=data.routes[0];
    const coords=r.geometry.coordinates.map(p=>[p[1],p[0]]);
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline(coords,{color:"#1DB7DD",weight:5}).addTo(map);
    map.fitBounds(routeLine.getBounds());

    navSteps=[];
    data.routes[0].legs.forEach(leg=>{ leg.steps.forEach(s=>{
      const type=s.maneuver?.type||"", modifier=s.maneuver?.modifier||"", name=s.name||"";
      let text="";
      if(type){ const typeMap={'turn':'–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ','new name':'–î–≤–∏–≥–∞–π—Ç–µ—Å—å –ø–æ','depart':'–ù–∞—á–Ω–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ','arrive':'–ü—Ä–∏–±—É–¥–µ—Ç–µ','merge':'–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å—ä–µ–∑–¥','roundabout':'–ù–∞ –∫–æ–ª—å—Ü–µ –¥–µ—Ä–∂–∏—Ç–µ—Å—å'};
        const modMap={'left':'–Ω–∞–ª–µ–≤–æ','right':'–Ω–∞–ø—Ä–∞–≤–æ','straight':'–ø—Ä—è–º–æ','slight left':'—Å–ª–µ–≥–∫–∞ –Ω–∞–ª–µ–≤–æ','slight right':'—Å–ª–µ–≥–∫–∞ –Ω–∞–ø—Ä–∞–≤–æ','uturn':'—Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ—Å—å'};
        text=(typeMap[type]||type)+(modifier? ' '+(modMap[modifier]||modifier):'')+(name? ' –Ω–∞ '+name:''); }else{text=name?'–î–≤–∏–≥–∞–π—Ç–µ—Å—å –ø–æ '+name:'–î–≤–∏–≥–∞–π—Ç–µ—Å—å';}
      const loc=s.maneuver?.location?[s.maneuver.location[1],s.maneuver.location[0]]:null;
      navSteps.push({location:loc,text,distance:Math.round(s.distance||0),raw:s});
    });});
    navIndex=0; lastSpokenKind=""; showToast(`–ú–∞—Ä—à—Ä—É—Ç –≥–æ—Ç–æ–≤ ‚Äî ${(r.distance/1000).toFixed(1)} –∫–º, ${Math.round(r.duration/60)} –º–∏–Ω`);
  }).catch(e=>{ console.error(e); showToast("–û—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞"); });
}

/* ====== Navigation ====== */
function startNavigation(){
  if(!destination) return showToast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ");
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; showToast("–ù–∞–≤–∏–≥–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"); return; }
  if(!navSteps.length) buildRoute(currentLocation,destination);
  watchId=navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude; currentLocation=[lat,lon];
    if(userMarker) userMarker.setLatLng(currentLocation); map.panTo(currentLocation);
    buildRoute(currentLocation,destination);

    if(!navSteps.length) return;
    while(navIndex<navSteps.length && (!navSteps[navIndex].location||map.distance(currentLocation,navSteps[navIndex].location)<5)) navIndex++;
    if(navIndex>=navSteps.length){ const distToDest=map.distance(currentLocation,destination); if(distToDest<=20){ showToast("–í—ã –ø—Ä–∏–±—ã–ª–∏!"); navigator.geolocation.clearWatch(watchId); watchId=null; } return; }

    const step=navSteps[navIndex]; if(!step.location){ navIndex++; return; }
    const distToStep=map.distance(currentLocation,step.location);
    if(distToStep<=15){ navIndex++; return; }
  }, err=>showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏"),{enableHighAccuracy:true,maximumAge:0,timeout:5000});
}

/* ====== Fetch transport lines ====== */
async function fetchTransportLines(latlon){
  const transportTypes=Array.from(document.querySelectorAll('#transportCheckboxes input:checked')).map(c=>c.value);
  if(!transportTypes.length) return;
  const bbox=[latlon[0]-0.05,latlon[1]-0.05,latlon[0]+0.05,latlon[1]+0.05];
  const key=bbox.join(",")+transportTypes.join(",");
  if(transportCache[key]) return renderTransportLines(transportCache[key]);

  const filters=transportTypes.map(t=>`route=${t}`).join("|");
  const query=`[out:json][timeout:25];(relation["type"="route"]["route"~"${filters}"](${bbox.join(',')}););out geom;`;
  try{
    const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
    const data=await res.json(); transportCache[key]=data; renderTransportLines(data);
  }catch(e){ console.error(e); showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –ª–∏–Ω–∏–π"); }
}
function renderTransportLines(data){
  stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[];
  transportRoutes.forEach(r=>map.removeLayer(r.line)); transportRoutes=[];
  const colors=["#1DB7DD","#FFAA00","#DD4444","#44DD44"];
  data.elements.forEach((rel,idx)=>{
    if(!rel.geometry) return;
    const coords=rel.geometry.map(p=>[p.lat,p.lon]);
    const line=L.polyline(coords,{color:colors[idx%colors.length],weight:4}).addTo(map);
    transportRoutes.push({name:rel.tags.name||rel.tags.ref||"–õ–∏–Ω–∏—è",line});
    if(rel.members) rel.members.filter(m=>m.role==="stop" || m.role==="stop_position").forEach(stop=>{
      if(stop.lat && stop.lon){ const marker=L.marker([stop.lat,stop.lon],{title: stop.tags?.name || "–û—Å—Ç–∞–Ω–æ–≤–∫–∞"}).addTo(map); marker.bindPopup(stop.tags?.name || '–û—Å—Ç–∞–Ω–æ–≤–∫–∞'); stopMarkers.push(marker); }
    });
  });
}

/* ====== Events ====== */
document.getElementById("btnLocate").onclick=requestLocationPermission;
document.getElementById("btnSearch").onclick=searchPlace;
document.getElementById("btnCar").onclick=()=>{ profile="car"; buildRoute(currentLocation,destination); showToast("üöó –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –∞–≤—Ç–æ"); };
document.getElementById("btnBike").onclick=()=>{ profile="bike"; buildRoute(currentLocation,destination); showToast("üö≤ –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞"); };
document.getElementById("btnFoot").onclick=()=>{ profile="foot"; buildRoute(currentLocation,destination); showToast("üö∂ –ü–µ—à–∏–π –º–∞—Ä—à—Ä—É—Ç"); };
document.getElementById("btnStart").onclick=startNavigation;
document.getElementById("btnClear").onclick=()=>{ if(routeLine) map.removeLayer(routeLine); if(destinationMarker) map.removeLayer(destinationMarker); stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[]; destination=null; showToast("–û—á–∏—â–µ–Ω–æ"); };
document.getElementById("btnRetry").onclick=()=>{ document.getElementById("permissionModal").style.display="none"; requestLocationPermission(); };
</script>
</body>
</html>
